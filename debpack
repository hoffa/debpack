#!/usr/bin/env bash
set -euo pipefail

init() {
    mkdir debian
    name=${PWD##*/}
    cat > debian/control << EOL
Package: ${name}
Description: ${name}
Version: 0.0.1
Depends:
Maintainer: Jane Doe <jane@doe.com>
Architecture: any
Section: misc
Priority: required
EOL
}

patch_version() {
    sed -i '' "s/Version:.*/Version: $2/" "$1"
}

build() {
    [[ -d .package ]] && rm -r .package
    mkdir -p .package/DEBIAN

    cp debian/control .package/DEBIAN/
    [[ -n ${1:-} ]] && patch_version .package/DEBIAN/control "$1"

    # Copy maintainer scripts
    for file in preinst postinst prerm postrm; do
        if [[ -f debian/${file} ]]; then
            cp "debian/${file}" .package/DEBIAN/
            chmod 0755 ".package/DEBIAN/${file}"
        fi
    done

    # Fail if no .debpack
    cat < .debpack | while IFS= read -r line || [[ -n ${line} ]]; do
        src=$(echo "${line}" | cut -f1)
        dst=.package$(echo "${line}" | cut -f2)
        mkdir -p "${dst%/*}"
        # Allow source wildcards
        # shellcheck disable=SC2086
        cp -v ${src} "${dst}"
    done

    fakeroot dpkg-deb --build .package
    dpkg-deb --info .package.deb
    dpkg-name --overwrite .package.deb
}

case ${1:-} in
    --help)
        echo "Usage: $0 [version] [--init] [--help]"
        ;;
    --init)
        init
        ;;
    *)
        build "$@"
        ;;
esac
