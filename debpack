#!/usr/bin/env bash
set -euo pipefail

init() {
    mkdir debian
    cat > debian/control << EOL
Package: hello-world
Description: hello-world
Version: 1.0.0
Depends:
Maintainer: Jane Doe <jane@doe.com>
Architecture: all
Section: misc
Priority: required
EOL
    cat > debian/postinst << EOL
#!/bin/sh
set -x
EOL
    chmod +x debian/postinst
    cat > hello-world << EOL
#!/bin/sh
echo "Hello, world!"
EOL
    chmod +x hello-world
    printf "hello-world\t/usr/bin/" > .debpack
}

patch_control() {
    # Support both BSD and GNU sed
    sed -i.bak "s/$2:.*/$2: $3/" "$1"
    rm "$1.bak"
}

cecho() {
    printf "\e[1;32m==> %s\e[0m\n" "$1"
}

cleanup() {
    if [[ -d .package ]]; then
        rm -r .package
    fi
}

build() {
    cleanup
    mkdir -p .package/DEBIAN

    cecho "Copying control file"
    cp -v debian/control .package/DEBIAN/

    cecho "Patching control file"
    if [[ -n ${1:-} ]]; then
        # Patch version
        patch_control .package/DEBIAN/control Version "$1"
    fi
    diff -u debian/control .package/DEBIAN/control || true

    cecho "Copying maintainer scripts"
    for file in preinst postinst prerm postrm; do
        if [[ -f debian/${file} ]]; then
            cp -v "debian/${file}" .package/DEBIAN/
            chmod 0755 ".package/DEBIAN/${file}"
        fi
    done

    cecho "Copying files"
    # Fail if no .debpack
    cat < .debpack | while IFS= read -r line || [[ -n ${line} ]]; do
        src=$(echo "${line}" | cut -f1)
        dst=.package$(echo "${line}" | cut -f2)
        mkdir -p "${dst%/*}"
        # Allow source wildcards
        # shellcheck disable=SC2086
        cp -v ${src} "${dst}"
    done

    cecho "Building package"
    fakeroot dpkg-deb --build .package

    dpkg-deb --info .package.deb
    dpkg --contents .package.deb
    dpkg-name --overwrite .package.deb

    cecho "Cleaning up"
    cleanup

    cecho "Done"
}

case ${1:-} in
    --help)
        echo "Usage: $0 [version] [--init] [--help]"
        ;;
    --init)
        init
        ;;
    *)
        build "$@"
        ;;
esac
